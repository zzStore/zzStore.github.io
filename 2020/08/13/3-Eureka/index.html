<!DOCTYPE html><html lang="zh-CN,zh-TW,en,ko,default"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="不要以泪水博取同情，而要以汗水赢得掌声。"><title>3-Eureka | 浴火重生</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">3-Eureka</h1><a id="logo" href="/.">浴火重生</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">3-Eureka</h1><div class="post-meta"><a href="/2020/08/13/3-Eureka/#comments" class="comment-count"></a><p><span class="date">Aug 13, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="Eureka基础知识"><a href="#Eureka基础知识" class="headerlink" title="Eureka基础知识"></a>Eureka基础知识</h1><h3 id="什么是服务注册"><a href="#什么是服务注册" class="headerlink" title="什么是服务注册"></a>什么是服务注册</h3><p>Eureka Server 作为服务注册功能的服务器，它是服务注册中心，而系统中其他微服务，使用 Eureka 的客户端连接到 Eureka Server 并维持心跳连接，这样系统维护人员就可以通过 Eureka Server来监控各个微服务是否正常运行。</p>
<p>在服务注册与发现中有一个注册中心，服务器启动时，会把当前自己的服务器信息比如服务地址，通信地址等注册到注册中心上，另一方（消费者）以别名的方式在注册中心上获取实际的服务器通讯地址，然后再实现本地RPC调用远程RPC。<br><img src="imgs/服务注册.png"></p>
<h3 id="Eureka的两个组件"><a href="#Eureka的两个组件" class="headerlink" title="Eureka的两个组件"></a>Eureka的两个组件</h3><ol>
<li>Eureka Server 提供服务注册服务<br>各个微服务节点通过配置启动后，会在 EurekaServer中进行注册，这样 EurekaServer中的服务注册表中将会存储所有可用服务节点的信息。</li>
<li>EurekaClient通过注册中心进行访问<br>是一个Java客户端，用于简化与 Eureka Server的交互，客户端也同时具备一个内置的，使用 轮询负载算法的负载均衡器。在应用启动后，将会向Eureka Server 发送心跳（默认周期30秒）。如果Eureka Server 在多个心跳周期内没有接收到某个节点的心跳，EurekaServer将会从服务注册表中将这个服务节点移除（默认90秒）</li>
</ol>
<h1 id="单机Eureka"><a href="#单机Eureka" class="headerlink" title="单机Eureka"></a>单机Eureka</h1><h3 id="IDEA生成eurekaServer端服务注册中心，类似物业公司"><a href="#IDEA生成eurekaServer端服务注册中心，类似物业公司" class="headerlink" title="IDEA生成eurekaServer端服务注册中心，类似物业公司"></a>IDEA生成eurekaServer端服务注册中心，类似物业公司</h3><ol>
<li>建Module<br>cloud-eureka-server7001</li>
<li><p>改pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-server--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入自己的公共api--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.wxh.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>写YML</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span> <span class="comment"># eureka服务端实例名称</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment">#false表示不向注册中心注册自己</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#false表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line">      <span class="comment"># 设置与 eureka server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line"><span class="attr">      defaultZone:</span>  <span class="attr">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 声明自己是 eureka 的服务端</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaMain7001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaMain7001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br>浏览器进入 <a href="http://localhost:7001/" target="_blank" rel="noopener">http://localhost:7001/</a> 看能不能看到 eureka 的服务页面</p>
<h3 id="EurekaClient端cloud-provider-payment8001-将注册进-EurekaServer-成为服务提供者-provider-，类似尚硅谷对外提供授课服务"><a href="#EurekaClient端cloud-provider-payment8001-将注册进-EurekaServer-成为服务提供者-provider-，类似尚硅谷对外提供授课服务" class="headerlink" title="EurekaClient端cloud-provider-payment8001 将注册进 EurekaServer 成为服务提供者 provider ，类似尚硅谷对外提供授课服务"></a>EurekaClient端cloud-provider-payment8001 将注册进 EurekaServer 成为服务提供者 provider ，类似尚硅谷对外提供授课服务</h3></li>
<li><p>引入坐标依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>更改yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment">#表示是否将自己注册进EurekaServer默认为true</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用 负载均衡</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span>  <span class="attr">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加注解<br>8001启动类添加@EnableEurekaClient注解</p>
</li>
<li>测试<br>进入<a href="http://localhost:7001/可以看到DS" target="_blank" rel="noopener">http://localhost:7001/可以看到DS</a> Replicas<br>Instances currently registered with Eureka 下的服务端口<h3 id="EurekaClient端-cloud-consumer-order80注册进EurekaServer成为服务注册者consumer，类似来尚硅谷上课的同学"><a href="#EurekaClient端-cloud-consumer-order80注册进EurekaServer成为服务注册者consumer，类似来尚硅谷上课的同学" class="headerlink" title="EurekaClient端 cloud-consumer-order80注册进EurekaServer成为服务注册者consumer，类似来尚硅谷上课的同学"></a>EurekaClient端 cloud-consumer-order80注册进EurekaServer成为服务注册者consumer，类似来尚硅谷上课的同学</h3>步骤同上<h1 id="集群Eureka构建步骤"><a href="#集群Eureka构建步骤" class="headerlink" title="集群Eureka构建步骤"></a>集群Eureka构建步骤</h1><h3 id="集群的目的"><a href="#集群的目的" class="headerlink" title="集群的目的"></a>集群的目的</h3>高可用，如果注册中心只有一个，出了故障就会导致整个服务环境不可用<br>解决方法：搭建Eureka注册中心集群，实现负载均衡+故障排错</li>
</ol>
<p><img src="imgs/eureka集群.png"><br>多个 eureka serve 相互注册，保障信息共享。</p>
<h3 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h3><ol>
<li>将7001模块复制</li>
<li>粘贴后修改 pom 文件，yml文件，主启动类</li>
<li>在主 pom 文件中的 moudles 中加入 7002 即可<h3 id="集群与单机的区别"><a href="#集群与单机的区别" class="headerlink" title="集群与单机的区别"></a>集群与单机的区别</h3></li>
<li>修改映射文件<br>找到 C:\Windows\System32\drivers\etc 下的 hosts文件添加<br>127.0.0.1    eureka7001.com<br>127.0.0.1    eureka7002.com</li>
<li><p>yml 文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 仅写修改的部分</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">eureka7001.com</span> <span class="comment"># eureka服务端实例名称，集群名字要不同有区分</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line">      <span class="comment"># 设置与 eureka server交互的地址查询服务和注册服务都需要依赖这个地址，因为两台集群所以相互注册</span></span><br><span class="line"><span class="attr">      defaultZone:</span>  <span class="attr">http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br>访问<br><a href="http://eureka7001.com:7001/" target="_blank" rel="noopener">http://eureka7001.com:7001/</a><br><a href="http://eureka7002.com:7002/" target="_blank" rel="noopener">http://eureka7002.com:7002/</a><br>可以看到两者相互注册</p>
</li>
<li>问题<br>三台集群如何相互守望注册<h3 id="把微服务模块-payment-与-order-发布到-eureka-集群上"><a href="#把微服务模块-payment-与-order-发布到-eureka-集群上" class="headerlink" title="把微服务模块 payment 与 order 发布到 eureka 集群上"></a>把微服务模块 payment 与 order 发布到 eureka 集群上</h3></li>
<li>修改两个模块的pom文件<br>defaultZone:  <a href="http://eureka7002.com:7002/eureka/,http://eureka7001.com:7001/eureka/" target="_blank" rel="noopener">http://eureka7002.com:7002/eureka/,http://eureka7001.com:7001/eureka/</a></li>
<li>测试，启动微服务<ol>
<li>7001/7002</li>
<li>8001</li>
<li>80</li>
<li><a href="http://localhost/consumer/payment/get/34" target="_blank" rel="noopener">http://localhost/consumer/payment/get/34</a><h3 id="支付模块微服务的集群配置"><a href="#支付模块微服务的集群配置" class="headerlink" title="支付模块微服务的集群配置"></a>支付模块微服务的集群配置</h3></li>
</ol>
</li>
<li>复制模块8001，更改端口为8002</li>
<li><p>修改 8001与8002的controller</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在各个方法中调用 serverPort 查看端口号</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.port&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String serverPort;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 80 中controller的PAYMENT_URL</p>
<ul>
<li>在之前单机版中写死为8001，但是集群后有8001与8002，</li>
<li>进入 <a href="http://eureka7001.com:7001/" target="_blank" rel="noopener">http://eureka7001.com:7001/</a> 查看 8001 与 8002 对应的名称 application</li>
<li>将 PAYMENT_URL 改为 http+application 名 :<a href="http://CLOUD-PAYMENT-SERVICE" target="_blank" rel="noopener">http://CLOUD-PAYMENT-SERVICE</a></li>
<li>此时未开启负载均衡不能访问页面：将80端口下的配置类ApplicationContextConfig 下生成的 RestTemplate 的bean方法上添加注解 @LoadBalanced</li>
<li><a href="http://localhost/consumer/payment/get/34" target="_blank" rel="noopener">http://localhost/consumer/payment/get/34</a> 访问查看端口号，可以看到在8001与8002之间来回切换<h1 id="actuator微服务信息完善"><a href="#actuator微服务信息完善" class="headerlink" title="actuator微服务信息完善"></a>actuator微服务信息完善</h1>修改主机名与暴露ip地址<br>可在<a href="http://eureka7002.com:7002/" target="_blank" rel="noopener">http://eureka7002.com:7002/</a> 查看自定义主机名的变化<br>鼠标在主机名上方，浏览器下面会出现ip地址<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">eureka</span></span><br><span class="line"><span class="attr">    instance:</span></span><br><span class="line"><span class="attr">      instance-id:</span> <span class="string">payment8002</span>  <span class="comment"># 自定义主机名</span></span><br><span class="line"><span class="attr">      prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 设置暴露ip地址</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h1 id="服务发现Discovery"><a href="#服务发现Discovery" class="headerlink" title="服务发现Discovery"></a>服务发现Discovery</h1><ol>
<li><p>8001 的 controller添加代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/payment/discovery"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> DiscoveryClient <span class="title">discovery</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 得到所有服务名</span></span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    services.forEach(ele-&gt;&#123;</span><br><span class="line">        log.info(<span class="string">"***service***"</span>+ele);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 得到服务名对应的信息</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">"CLOUD-PAYMENT-SERVICE"</span>);</span><br><span class="line">    instances.forEach(ele-&gt;&#123;</span><br><span class="line">        log.info(ele.getServiceId()+<span class="string">"\t"</span>+ele.getHost()+<span class="string">"\t"</span>+ele.getPort()+<span class="string">"\t"</span>+ele.getUri());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> discoveryClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>8001 主类添加注解 @EnableDiscoveryClient</p>
</li>
<li>重启服务，观察日志</li>
</ol>
<h1 id="eureka自我保护"><a href="#eureka自我保护" class="headerlink" title="eureka自我保护"></a>eureka自我保护</h1><h3 id="自我保护理论"><a href="#自我保护理论" class="headerlink" title="自我保护理论"></a>自我保护理论</h3><ol>
<li>为什么会产生自我保护？<br>为了防止 EurekaClient 可以正常运行，但是在 EurekaServer 网络不通的情况下，EurekaServer 不会立刻将 EurekaClient 服务剔除。</li>
<li>什么是自我保护模式？<br>默认情况下，EurekaServer在一定时间内没有接收到某个微服务实例的心跳，EurekaServer将会注销该实例（默认90s），但是当网络分区故障发生，微服务与 EurekaServer 之间无法正常通信，以上行为就非常危险。当EurekaServer节点在短时间内丢失过多客户端时，那么这个节点就会进入自我保护模式。<h3 id="禁止自我保护"><a href="#禁止自我保护" class="headerlink" title="禁止自我保护"></a>禁止自我保护</h3></li>
<li>将 7001 与 8001 改为单机版：修改对应 eureka 地址</li>
<li><p>yml文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  server:</span></span><br><span class="line">    <span class="comment"># 关闭自我保护机制</span></span><br><span class="line"><span class="attr">    enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 心跳时间默认90s，改为2000ms，即2s</span></span><br><span class="line"><span class="attr">    eviction-interval-timer-in-ms:</span> <span class="number">2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line">    <span class="comment">#eureka客户端发送心跳的时间间隔，默认30s</span></span><br><span class="line"><span class="attr">    lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment">#eureka服务端在收到最后一次心跳等待的时间上线，默认90s</span></span><br><span class="line"><span class="attr">    lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<ol>
<li>访问 <a href="http://eureka7001.com:7001/" target="_blank" rel="noopener">http://eureka7001.com:7001/</a> 可以看到红字THE SELF PRESERVATION MODE IS TURNED OFF. THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK/OTHER PROBLEMS.代表自我保护关闭</li>
<li>关闭8001服务可以看到在 eureka 页面两秒后 8001 服务消失</li>
</ol>
</li>
</ol>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2020/08/13/2-Springcloud项目实践/" class="pre">2-Springcloud项目实践</a><a href="/2020/08/13/4-Zookeeper/" class="next">4-Zookeeper</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka基础知识"><span class="toc-text">Eureka基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是服务注册"><span class="toc-text">什么是服务注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka的两个组件"><span class="toc-text">Eureka的两个组件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#单机Eureka"><span class="toc-text">单机Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IDEA生成eurekaServer端服务注册中心，类似物业公司"><span class="toc-text">IDEA生成eurekaServer端服务注册中心，类似物业公司</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EurekaClient端cloud-provider-payment8001-将注册进-EurekaServer-成为服务提供者-provider-，类似尚硅谷对外提供授课服务"><span class="toc-text">EurekaClient端cloud-provider-payment8001 将注册进 EurekaServer 成为服务提供者 provider ，类似尚硅谷对外提供授课服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EurekaClient端-cloud-consumer-order80注册进EurekaServer成为服务注册者consumer，类似来尚硅谷上课的同学"><span class="toc-text">EurekaClient端 cloud-consumer-order80注册进EurekaServer成为服务注册者consumer，类似来尚硅谷上课的同学</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#集群Eureka构建步骤"><span class="toc-text">集群Eureka构建步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#集群的目的"><span class="toc-text">集群的目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搭建集群"><span class="toc-text">搭建集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群与单机的区别"><span class="toc-text">集群与单机的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#把微服务模块-payment-与-order-发布到-eureka-集群上"><span class="toc-text">把微服务模块 payment 与 order 发布到 eureka 集群上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#支付模块微服务的集群配置"><span class="toc-text">支付模块微服务的集群配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#actuator微服务信息完善"><span class="toc-text">actuator微服务信息完善</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务发现Discovery"><span class="toc-text">服务发现Discovery</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#eureka自我保护"><span class="toc-text">eureka自我保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自我保护理论"><span class="toc-text">自我保护理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#禁止自我保护"><span class="toc-text">禁止自我保护</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/1-Springcloud版本介绍/">1-Springcloud版本介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/2-Springcloud项目实践/">2-Springcloud项目实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/3-Eureka/">3-Eureka</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/4-Zookeeper/">4-Zookeeper</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/5-Consul/">5-Consul</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/6-Ribbon/">6-Ribbon</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/7-OpenFeign/">7-OpenFeign</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/8-Hystrix/">8-Hystrix</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/9-GetWay/">9-GetWay</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/10-Config/">10-Config</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/hexo/" style="font-size: 15px;">hexo</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">zhengzhong.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>